@model PersonalFinance.Models.Plaid
@{
    ViewBag.Title = "Account Sync";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@if (ViewBag.Message != null)
{
    <div class=" alert alert-success container-fluid col-md-4 col-md-offset-4" role="alert">
        <b>Great! </b><span>@ViewBag.Message</span>
    </div>
}
<div class="container-center animated slideInDown">
    <div class="row">
        <div class="col-lg-12">
            <div class="view-header">
                <div class="header-icon">
                    <i class="pe page-header-icon pe-7s-piggy"></i>
                </div>
                <div class="header-title">
                    @if (!Model.Has_accounts)
                    {
                        <h3>Sync Up Your Accounts!</h3>
                    }
                    else
                    {
                        <h3>My Synced Accounts</h3>
                    }
                </div>
            </div>
            <hr />
        </div>
    </div>
    @if (Model.Has_accounts)
            {
                foreach (var accounttype in Model.AccountTypeList)
                {
            <ul class="media-list">
                <li class="media">
                    <div class="media-left">
                        <span class="h3"><i class="fa fa-bank text-warning"></i></span>
                    </div>
                    <div class="media-body">
                        <b class="media-heading h3 text-warning text-capitalize">@accounttype.ToString()</b>
                        <ul class="media-list">
                            @foreach (var account in Model.Account_list)
                            {
                                if (account.Account_Type.Equals(accounttype.ToString()))
                                {
                                    <li class="media">
                                        <div class="media-heading">
                                            <text class="text-warning">@account.Institution_name.ToString()</text>
                                            <button class="pull-right btn-circle btn-danger" type="button" onclick="location.href='@Url.Action("DeleteAccount", "Account", new { access_token = account.Access_Token } )'"><i class="fa fa-trash-o"></i></button>
                                            <div class="media-body">
                                                
                                                <text> @account.AccountName.ToString()</text>
                                                <span class="badge"> $@account.Balance</span>
                                            </div>
                                            @*<button class="pull-right btn btn-danger" type="button" data-toggle="modal" data- data-target="#myModal"><i class="fa fa-trash-o"></i></button>*@
                                        </div>
                                    </li>
                                }
                                <content class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-body  text-center">
                                                <h4 class="m-t-none">Are you sure you want to delete this account?</h4>
                                                <p>Deleting an account will <b>permanently delete</b> the account but all of those transactions!</p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="pull-left btn btn-primary" data-dismiss="modal">Nevermind!</button>
                                                <button type="button" class="pull-right btn btn-danger" id="" onclick="href='@Url.Action("DeleteAccount", "Account", new { access_token = account.Access_Token } )'">Delete Away</button>
                                            </div>
                                        </div>
                                    </div>
                                </content>
                            }
                        </ul>
                    </div>
                </li>
            </ul>
        }

        <br />
                                <button class="btn btn-primary" id="link-button" type="button">Add Another Account</button>

                                <a href="@Url.Action("Main", "Dashboard")" role="button" class="btn btn-accent pull-right">All Set!</a>
    }
    else
    {
        <h4>You have no accounts synced!</h4>
                                <small> Click the button below to get started. </small>
                                <br />
                                <br />
                                <button class="btn btn-primary btn-block" id="link-button" type="button">Add An Account</button>
    }
</div>


<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script type="text/javascript">
        var handler = Plaid.create({
            clientName: 'Plaid Walkthrough Demo',
            env: 'development',
            key: 'f326b59ea06cf5309ebd2861388d13', // Replace with your public_key to test with live credentials
            product: ['transactions'],
            webhook: 'https://dhwebhookentry.azurewebsites.net/api/PlaidWebHook?code=t6wJsM/S4m1Sg1H4SutHgArWcPSNSSTEqu6rbSWiaY6rCPSLDynamw==',
            onSuccess: function (public_token, metadata) {
                // Send the public_token to your app server.
                // The metadata object contains info about the institution the
                // user selected and the account ID, if `selectAccount` is enabled.
                $.post('@Url.Action("AccountViewSync","Account")', {
                    data: { public_token: public_token, name: metadata.institution.name}
                }, function () {
                    window.location.reload(true);
                });
            },
            onExit: function (err, metadata) {
                //User exited pop up
                if (err != null) {
                    // The user encountered a Plaid API error prior to exiting.
                }
                // metadata contains information about the institution
                // that the user selected and the most recent API request IDs.
                // Storing this information can be helpful for support.
            }
        });

        $('#link-button').on('click', function (e) {
            handler.open();
            // Alternatively, you can have a specific institution
            // prompt for authentication. Example:
            //
            // handler.open('ins_100000');
            //
            // This will open Link with Union Bank as the institution.
        });
</script>
